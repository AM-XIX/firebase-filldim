<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Capture the Flag ‚Äî Game</title>

<style>
  :root {
    --bg: #e0d9be;
    --panel: #eae6ce;
    --ink: #1a1a1a;
    --muted: #6b6b6b;
    --line: #d9d4bb;
    --chip: #e9e6d4;
    --green: #1aa84b;
    --ref: #444;
  }
  html,
  body {
    background: var(--bg);
    color: var(--ink);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }
  body {
    max-width: 1100px;
    margin: 24px auto;
    padding: 0 16px;
  }

  /* TOP BAR */
  .topbar {
    display: grid;
    grid-template-columns: auto 1fr auto auto auto 1fr auto;
    gap: 12px;
    align-items: center;
    margin-bottom: 16px;
  }
  .emblem {
    width: 44px;
    height: 44px;
    object-fit: cover;
    border: 1px solid rgba(0, 0, 0, 0.06);
    background: #ddd;
  }
  .teamName {
    font-weight: 800;
    font-size: 26px;
    white-space: nowrap;
  }
  .score {
    font-weight: 700;
    font-size: 32px;
    letter-spacing: 1px;
  }
  .right {
    text-align: right;
  }
  .vs {
    font-weight: 800;
    color: var(--muted);
    letter-spacing: 0.1em;
  }

  /* CHAT */
  .chat-wrap {
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 14px;
  }
  #chatBox {
    height: 360px;
    overflow: auto;
    background: #e6e1c6;
    border: 1px solid var(--line);
    padding: 10px;
  }
  .chat-line {
    background: #fff;
    border-left: 6px solid var(--line);
    padding: 8px 10px;
    margin: 8px 0;
    border-radius: 4px;
    box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.03) inset;
    font-size: 14px;
  }
  .chat-line .who {
    font-weight: 700;
  }
  .chat-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-top: 10px;
  }
  .chat-controls input {
    flex: 1;
    padding: 10px;
    font-size: 14px;
    border: 1px solid var(--line);
    border-radius: 4px;
    background: #fff;
  }
  .btn {
    padding: 10px 12px;
    border: 1px solid #9aa283;
    background: #9bb16b;
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }
  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .btn-plain {
    background: #fff;
    color: #333;
    border-color: var(--line);
  }
  .btn-icon {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .muted {
    color: var(--muted);
    font-size: 13px;
  }

  .score-controls {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .score-controls .ptsInput,
  .points-input {
    width: 110px;
    padding: 10px;
    border: 1px solid var(--line);
    border-radius: 8px;
    background: #fff;
  }

  .score-controls .btnScore {
    padding: 10px 12px;
    border: 1px solid #9aa283;
    background: #9bb16b;
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    line-height: 1;
    min-width: 40px;
    text-align: center;
  }

  .score-controls .btnScore:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* LOGIN STRIP */
  .strip {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 16px;
    align-items: center;
    margin: 10px 0 18px;
  }
  .login-form {
    display: none;
    background: #f0ecd6;
    border: 1px dashed var(--line);
    padding: 10px;
    border-radius: 6px;
    gap: 8px;
    align-items: center;
  }
  .login-form.active {
    display: flex;
    flex-wrap: wrap;
  }
  .login-form input[type="email"] {
    min-width: 260px;
    padding: 10px;
    border: 1px solid var(--line);
    border-radius: 6px;
    background: #fff;
  }
  .radio {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin: 0 8px 0 0;
    padding: 6px 10px;
    background: #efe9c9;
    border: 1px solid var(--line);
    border-radius: 999px;
  }
  .meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }
  .meta .who {
    font-weight: 700;
  }

  /* REFEREE PANEL */
  .panel {
    background: #f1edd2;
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 14px;
    margin: 16px 0;
  }
  .panel h3 {
    margin: 0 0 10px;
    font-size: 18px;
  }
  .ref-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 18px;
    align-items: start;
  }
  .ref-team {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #fcfaf0;
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 10px;
  }
  .ref-team .ctl {
    margin-left: auto;
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .points-input {
    width: 110px;
    padding: 10px;
    border: 1px solid var(--line);
    border-radius: 8px;
    background: #fff;
  }
  .badge {
    background: #ece7cd;
    border: 1px solid var(--line);
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 13px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 10px 0;
  }
  .toolbar .pill {
    padding: 8px 12px;
    border: 1px solid var(--line);
    background: #efe9c9;
    border-radius: 999px;
    font-size: 13px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .toolbar .pill .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #aaa;
  }

  /* PLAYERS */
  .players {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin: 20px 0 40px;
  }
  .players h3 {
    font-size: 24px;
    font-weight: 800;
    margin: 0 0 6px;
    border-bottom: 2px solid var(--ink);
    padding-bottom: 6px;
  }
  .plist {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .plist li {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    padding: 4px 0;
    font-size: 15px;
  }
  .role {
    color: var(--muted);
    min-width: 90px;
    text-align: right;
  }
  .dotL,
  .dotR {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--green);
    display: inline-block;
  }
  .line-left {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .line-right {
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: flex-end;
  }

  /* DEV pills hidden */
  .dev {
    display: none;
  }
</style>

<script>
  window.GAME_ID = "B9T5bfx3XdTFRslgbh5J";
  try {
    const sp = new URLSearchParams(location.search);
    const q = sp.get("game");
    if (q) window.__GAME_ID_OVERRIDE = q;
  } catch {}
</script>

<!-- TOP BAR -->
<div class="topbar">
  <img id="emblemA" class="emblem" alt="" />
  <div class="teamName" id="teamAName">Team A</div>
  <div class="score" id="scoreA">0</div>
  <div class="vs">VS</div>
  <div class="score right" id="scoreB">0</div>
  <div class="teamName right" id="teamBName">Team B</div>
  <img id="emblemB" class="emblem" alt="" />
</div>

<!-- CHAT -->
<div class="chat-wrap">
  <div id="chatBox"></div>
  <div class="chat-controls" id="chatControls">
    <input id="chatInput" placeholder="Write a message‚Ä¶" />
    <button class="btn" id="chatSend">Send</button>
  </div>
</div>

<!-- LOGIN STRIP -->
<div class="strip">
  <button class="btn-plain" id="btnToggleLogin">Login</button>
  <div class="meta">
    <div class="muted">
      Logged in as: <span class="who" id="whoIAm">Spectator</span>
    </div>
  </div>
  <div class="muted">Referee: <span id="refereeBadge">‚Äî</span></div>
</div>

<div class="login-form" id="loginForm">
  <input
    id="fullName"
    type="text"
    placeholder="Full name (exactly as on roster)"
  />
  <input id="password" type="password" placeholder="Password" />
  <label class="radio"
    ><input type="radio" name="role" value="player" checked /> Player</label
  >
  <label class="radio"
    ><input type="radio" name="role" value="referee" /> Referee</label
  >
  <button class="btn" id="btnClaim">Join</button>
  <span class="muted" id="loginMsg"></span>
</div>

<!-- REFEREE PANEL -->
<div class="panel" id="refPanel" style="display: none">
  <h3>Referee</h3>

  <div class="ref-grid">
    <div class="ref-team">
      <img id="refEmblemA" class="emblem" alt="" />
      <strong id="refTeamALabel">Team A</strong>
      <div class="score-controls" data-team="A">
        <input type="number" class="ptsInput" placeholder="Points" min="1" />
        <button class="btn btnScore" data-team="A" data-sign="plus">+</button>
        <button class="btn btnScore minus" data-team="A" data-sign="minus">
          ‚àí
        </button>
      </div>
    </div>

    <div class="ref-team">
      <img id="refEmblemB" class="emblem" alt="" />
      <strong id="refTeamBLabel">Team B</strong>
      <div class="score-controls" data-team="B">
        <input type="number" class="ptsInput" placeholder="Points" min="1" />
        <button class="btn btnScore" data-team="B" data-sign="plus">+</button>
        <button class="btn btnScore" data-team="B" data-sign="minus">‚àí</button>
      </div>
    </div>
  </div>

  <!-- (UI only) -->
  <div class="toolbar">
    <span class="pill"><span class="dot"></span> All</span>
    <span class="pill"><span class="dot"></span> Keeper</span>
    <span class="pill"><span class="dot"></span> Beaters</span>
    <span class="pill"><span class="dot"></span> Chasers</span>
    <span class="pill"><span class="dot"></span> Seeker</span>
  </div>

  <div class="chat-controls">
    <input placeholder="Write a message‚Ä¶" disabled />
    <button class="btn" disabled>Send</button>
    <button class="btn-plain" disabled>‚è±</button>
    <button class="btn-plain" disabled>‚ñæ</button>
  </div>

  <div style="margin-top: 10px">
    <button class="btn btn-icon" id="btnRoll" disabled>üé≤ Roll the dice</button>
  </div>
</div>

<!-- PLAYERS -->
<div class="players">
  <div>
    <h3 id="listALabel">Team A</h3>
    <ul class="plist" id="playersA"></ul>
  </div>
  <div>
    <h3 id="listBLabel" style="text-align: right">Team B</h3>
    <ul class="plist" id="playersB"></ul>
  </div>
</div>

<!-- DEV pills (hidden) -->
<div class="dev">
  <strong>Status</strong>
  <div>ID: <code id="gameIdLabel">‚Äî</code></div>
  <div id="me">Signing in‚Ä¶</div>
  <div class="status">
    <div class="pill" id="stInit">Init</div>
    <div class="pill" id="stAuth">Auth</div>
    <div class="pill" id="stFS">Firestore</div>
    <div class="pill" id="stGame">Game</div>
  </div>
  <div id="authInfo" class="muted">&nbsp;</div>
</div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
<script>
  /* ===================== 1) Tiny utils ===================== */
  function setPill(id, state, msg) {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.remove("ok", "err", "warn");
    if (state) el.classList.add(state);
    if (msg) el.textContent = msg;
  }
  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (m) =>
      m === "&"
        ? "&amp;"
        : m === "<"
        ? "&lt;"
        : m === ">"
        ? "&gt;"
        : m === '"'
        ? "&quot;"
        : "&#39;"
    );
  }
  function nameKeyFromFull(n) {
    return (n || "")
      .trim()
      .toLowerCase()
      .replace(/\s+/g, " ")
      .replace(/\//g, "-");
  }

  /* ===================== 2) Resolve GAME_ID early ===================== */
  let resolvedGameId = "";
  (function resolveGameId() {
    try {
      const sp = new URLSearchParams(location.search);
      const q = (sp.get("game") || "").trim();
      if (q) {
        resolvedGameId = q;
        console.debug("[Game] Using ?game=", resolvedGameId);
        return;
      }
    } catch {}

    if (
      typeof window.__GAME_ID_OVERRIDE !== "undefined" &&
      String(window.__GAME_ID_OVERRIDE).trim()
    ) {
      resolvedGameId = String(window.__GAME_ID_OVERRIDE).trim();
      console.debug("[Game] Using __GAME_ID_OVERRIDE =", resolvedGameId);
      return;
    }

    // Support both "const GAME_ID = ‚Ä¶" and "window.GAME_ID = ‚Ä¶"
    if (typeof GAME_ID !== "undefined" && String(GAME_ID).trim()) {
      resolvedGameId = String(GAME_ID).trim();
      console.debug("[Game] Using global GAME_ID =", resolvedGameId);
      return;
    }
    if (
      typeof window.GAME_ID !== "undefined" &&
      String(window.GAME_ID).trim()
    ) {
      resolvedGameId = String(window.GAME_ID).trim();
      console.debug("[Game] Using window.GAME_ID =", resolvedGameId);
      return;
    }

    console.error(
      "[Game] No GAME_ID found. Add ?game=ID or set GAME_ID earlier."
    );
  })();

  /* ===================== 3) Firebase ===================== */
  const firebaseConfig = {
    apiKey: "AIzaSyCyl03UVC3DVUMqZmd01wUdvaowZBBGYqo",
    authDomain: "filldim-dev.firebaseapp.com",
    projectId: "filldim-dev",
    storageBucket: "filldim-dev.firebasestorage.app",
    messagingSenderId: "843763394432",
    appId: "1:843763394432:web:6cad7a2971f8df1fc68365",
    measurementId: "G-99BQCKJS3B",
  };
  try {
    firebase.initializeApp(firebaseConfig);
    setPill("stInit", "ok", "Init OK");
  } catch {
    setPill("stInit", "err", "Init FAIL");
  }
  const auth = firebase.auth();
  const db = firebase.firestore();

  /* ===================== 4) DOM refs ===================== */
  const topAName = document.getElementById("teamAName");
  const topBName = document.getElementById("teamBName");
  const topAScore = document.getElementById("scoreA");
  const topBScore = document.getElementById("scoreB");
  const emblemA = document.getElementById("emblemA");
  const emblemB = document.getElementById("emblemB");

  const chatBox = document.getElementById("chatBox");
  const chatInput = document.getElementById("chatInput");
  const chatSend = document.getElementById("chatSend");
  const chatCtrls = document.getElementById("chatControls");

  const btnToggleLogin = document.getElementById("btnToggleLogin");
  const loginForm = document.getElementById("loginForm");
  const fullNameEl = document.getElementById("fullName");
  const passEl = document.getElementById("password");
  const btnClaim = document.getElementById("btnClaim");
  const loginMsg = document.getElementById("loginMsg");

  const whoIAm = document.getElementById("whoIAm");
  const refereeBadge = document.getElementById("refereeBadge");

  const refPanel = document.getElementById("refPanel");
  const refEmblemA = document.getElementById("refEmblemA");
  const refEmblemB = document.getElementById("refEmblemB");
  const refTeamALabel = document.getElementById("refTeamALabel");
  const refTeamBLabel = document.getElementById("refTeamBLabel");

  const listALabel = document.getElementById("listALabel");
  const listBLabel = document.getElementById("listBLabel");
  const playersA = document.getElementById("playersA");
  const playersB = document.getElementById("playersB");

  /* ===================== 5) State ===================== */
  let uid = null;

  let lastGame = null;
  let rosterByKey = {};

  let mySession = null;
  let iAmPlayer = false;

  let unsubGame = null,
    unsubRoster = null,
    unsubChat = null,
    unsubSession = null;

  /* ===================== 6) Helpers ===================== */
  function teamColor(team) {
    if (!lastGame) return "#ccc";
    if (team === "A") return lastGame.team_a_color || "#6b7d3b";
    if (team === "B") return lastGame.team_b_color || "#7a6b3b";
    return "#ccc";
  }
  function updateWho() {
    if (iAmRef) {
      whoIAm.textContent = "Referee";
      return;
    }
    if (iAmPlayer) {
      const nk = mySession?.name_key;
      const t = nk && rosterByKey[nk] ? rosterByKey[nk].team : null;
      whoIAm.textContent =
        t === "A"
          ? `Player (${lastGame?.team_a_name || "Team A"})`
          : `Player (${lastGame?.team_b_name || "Team B"})`;
      return;
    }
    whoIAm.textContent = "Spectator";
  }
  function updateChatControls() {
    const ok = iAmRef || iAmPlayer;
    chatInput.disabled = !ok;
    chatSend.disabled = !ok;
    chatCtrls.style.opacity = ok ? "1" : ".6";
  }

  /* ===================== 7) Login UI (password method) ===================== */
  btnToggleLogin.onclick = () => {
    loginForm.classList.toggle("active");
    if (loginForm.classList.contains("active")) {
      fullNameEl?.focus();
      if (loginMsg) loginMsg.textContent = "";
    }
  };

  // Join as Player or Referee (full name + password)
  btnClaim.onclick = async () => {
    try {
      if (loginMsg) loginMsg.textContent = "Joining‚Ä¶";

      const fullName = (fullNameEl?.value || "").trim();
      const pwd = (passEl?.value || "").trim();
      const role =
        document.querySelector('input[name="role"]:checked')?.value || "player";

      if (!fullName) {
        if (loginMsg) loginMsg.textContent = "Enter your full name.";
        return;
      }
      if (!pwd) {
        if (loginMsg) loginMsg.textContent = "Enter the password.";
        return;
      }

      const nameKey = nameKeyFromFull(fullName);
      const gameRef = db.doc(`games/${resolvedGameId}`);

      if (role === "player") {
        const rosterSnap = await gameRef
          .collection("players_by_name")
          .doc(nameKey)
          .get();
        if (!rosterSnap.exists) {
          if (loginMsg)
            loginMsg.textContent =
              "This name is not on the roster. Ask the organizer.";
          return;
        }
      }

      // 1) Claim the name: sessions_by_name/{nameKey}
      await gameRef.collection("sessions_by_name").doc(nameKey).set({
        uid,
        display_name: fullName,
        type: role, // 'player' | 'referee'
        join_secret: pwd, // compared by Rules
        ts: firebase.firestore.FieldValue.serverTimestamp(),
      });

      await gameRef
        .collection("sessions_by_uid")
        .doc(uid)
        .set(
          {
            type: role,
            name_key: role === "player" ? nameKey : nameKey,
          },
          { merge: true }
        );

      if (role === "referee") {
        try {
          await gameRef.set({ referee_name: fullName }, { merge: true });
        } catch (_) {
          /* non-fatal */
        }
      }

      if (passEl) passEl.value = "";
      if (loginMsg)
        loginMsg.textContent =
          role === "referee" ? "You are now the referee." : "Joined as player.";

      loginForm?.classList.remove("active");
    } catch (e) {
      console.error(e);
      if (loginMsg) {
        loginMsg.textContent =
          e?.code === "permission-denied"
            ? "Invalid name or password, or this name is already in use."
            : "Join failed: " + (e?.message || String(e));
      }
    }
  };

  passEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      btnClaim.click();
    }
  });

  /* ===================== 8) Auth boot ===================== */
  setPill("stAuth", null, "Auth‚Ä¶");
  auth.onAuthStateChanged(async () => {
    try {
      if (!auth.currentUser) await auth.signInAnonymously();
      uid = auth.currentUser.uid;
      setPill("stAuth", "ok", "Auth OK (anon)");

      if (!resolvedGameId) {
        setPill("stGame", "err", "No GAME_ID");
        return;
      }

      // Verify the game exists (better status)
      const test = await db.doc(`games/${resolvedGameId}`).get();
      if (!test.exists) {
        setPill("stGame", "err", "Game not found");
        return;
      }
      setPill("stFS", "ok", "Firestore OK");

      // Wire listeners
      wireGame(resolvedGameId);
      wireRoster(resolvedGameId);
      wireSession(resolvedGameId);
      wireChat(resolvedGameId);
    } catch (e) {
      console.error("[Auth] Error:", e);
      setPill("stAuth", "err", "Auth FAIL");
    }
  });

  /* ===================== 9) Game snapshot (names, scores, emblems) ===================== */
  function wireGame(gameId) {
    if (unsubGame) unsubGame();
    const gameRef = db.doc(`games/${gameId}`);
    unsubGame = gameRef.onSnapshot(
      (snap) => {
        if (!snap.exists) {
          setPill("stGame", "err", "Game not found");
          return;
        }
        const g = snap.data();
        lastGame = g;

        topAName.textContent = g.team_a_name || "Team A";
        topBName.textContent = g.team_b_name || "Team B";
        topAScore.textContent = g.score_a ?? 0;
        topBScore.textContent = g.score_b ?? 0;

        if (g.team_a_emblem) emblemA.src = g.team_a_emblem;
        else emblemA.removeAttribute("src");
        if (g.team_b_emblem) emblemB.src = g.team_b_emblem;
        else emblemB.removeAttribute("src");

        refereeBadge.textContent = g.referee_name || "‚Äî";

        // Mirror in the referee panel header
        refEmblemA.src = emblemA.src || "";
        refEmblemB.src = emblemB.src || "";
        refTeamALabel.textContent = topAName.textContent;
        refTeamBLabel.textContent = topBName.textContent;

        // Score controls ‚Äî enable only if iAmRef (Rules still enforce)
        document.querySelectorAll(".score-controls").forEach((ctrl) => {
          const team = (ctrl.getAttribute("data-team") || "").toUpperCase();
          const input = ctrl.querySelector(".ptsInput");
          ctrl.querySelectorAll(".btnScore").forEach((btn) => {
            btn.disabled = !iAmRef;
            btn.style.opacity = iAmRef ? "1" : "0.6";
            btn.style.cursor = iAmRef ? "pointer" : "not-allowed";
            btn.onclick = async () => {
              if (!iAmRef) return;
              const raw = (input?.value || "").trim();
              const amt = parseInt(raw, 10);
              if (!Number.isFinite(amt) || amt <= 0) {
                alert("Enter a positive number of points.");
                return;
              }
              const sign = btn.getAttribute("data-sign") === "minus" ? -1 : 1;
              const delta = amt * sign;
              try {
                await gameRef.update(
                  team === "A"
                    ? {
                        score_a: firebase.firestore.FieldValue.increment(delta),
                      }
                    : {
                        score_b: firebase.firestore.FieldValue.increment(delta),
                      }
                );
                if (input) input.value = ""; // reset after success
              } catch (e) {
                alert("Score update failed: " + e.message);
              }
            };
          });
        });

        setPill("stGame", "ok", "Game OK");
      },
      (err) => {
        console.error("[wireGame] error:", err);
        setPill("stGame", "err", "Game error");
      }
    );
  }

  /* ===================== 10) Roster (players list) ===================== */
  function wireRoster(gameId) {
    if (unsubRoster) unsubRoster();
    const ref = db.collection("games").doc(gameId).collection("players");

    unsubRoster = ref.onSnapshot((qs) => {
      rosterByKey = {};
      playersA.innerHTML = "";
      playersB.innerHTML = "";
      const a = [],
        b = [];

      qs.forEach((doc) => {
        const p = doc.data();
        const nm = p.display_name || "Unknown";
        const key = nameKeyFromFull(nm);
        rosterByKey[key] = {
          team: p.team || null,
          role: p.role || null,
          display_name: nm,
        };

        const li = document.createElement("li");
        const roleEl = `<span class="role">${escapeHtml(p.role || "")}</span>`;
        if (p.team === "A") {
          li.innerHTML = `<div class="line-left"><strong>${escapeHtml(
            nm
          )}</strong></div>${roleEl}`;
          a.push(li);
        } else {
          li.innerHTML = `${roleEl}<div class="line-right"><strong>${escapeHtml(
            nm
          )}</strong></div>`;
          b.push(li);
        }
      });

      a.forEach((li) => playersA.appendChild(li));
      b.forEach((li) => playersB.appendChild(li));
      listALabel.textContent = lastGame?.team_a_name || "Team A";
      listBLabel.textContent = lastGame?.team_b_name || "Team B";

      // Refresh chat sendability (in case roster was needed to compute team)
      updateWho();
      updateChatControls();
    });
  }

  /* ===================== 11) My session (who am I?) ===================== */
  function wireSession(gameId) {
    if (unsubSession) unsubSession();
    const meRef = db
      .collection("games")
      .doc(gameId)
      .collection("sessions_by_uid")
      .doc(uid);

    unsubSession = meRef.onSnapshot((snap) => {
      mySession = snap.exists ? snap.data() || null : null;
      iAmRef = !!mySession && mySession.type === "referee";
      iAmPlayer = !!mySession && mySession.type === "player";
      refPanel.style.display = iAmRef ? "block" : "none";
      updateWho();
      updateChatControls();
    });
  }

  /* ===================== 12) Chat ===================== */
  function wireChat(gameId) {
    if (unsubChat) unsubChat();
    const ref = db
      .collection("games")
      .doc(gameId)
      .collection("messages")
      .orderBy("created_at", "asc");

    unsubChat = ref.onSnapshot((qs) => {
      chatBox.innerHTML = "";
      qs.forEach((d) => {
        const m = d.data();
        let c = "#ccc";
        if (m.author_type === "referee") c = "var(--ref)";
        else if (m.author_team) c = teamColor(m.author_team);

        const who =
          m.display_name ||
          (m.author_type === "referee" ? "Referee" : "Player");
        const div = document.createElement("div");
        div.className = "chat-line";
        div.style.borderLeftColor = c;
        div.innerHTML = `<span class="who">${escapeHtml(
          who
        )}</span> ‚Äî ${escapeHtml(m.text || "")}`;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  chatSend.onclick = async () => {
    const txt = (chatInput.value || "").trim();
    if (!txt) return;
    if (!(iAmRef || iAmPlayer)) {
      alert("Only players or the referee may send messages.");
      return;
    }

    try {
      const messages = db
        .collection("games")
        .doc(resolvedGameId)
        .collection("messages");
      if (iAmRef) {
        await messages.add({
          game_id: resolvedGameId,
          text: txt,
          author_type: "referee",
          display_name: (lastGame && lastGame.referee_name) || "Referee",
          created_at: firebase.firestore.FieldValue.serverTimestamp(),
        });
      } else {
        const nameKey = mySession?.name_key || null;
        const roster = nameKey ? rosterByKey[nameKey] : null;
        if (!nameKey || !roster || !roster.team || !roster.role) {
          alert(
            "Your roster entry is missing. Ask the organizer to check your name."
          );
          return;
        }
        await messages.add({
          game_id: resolvedGameId,
          text: txt,
          author_type: "player",
          author_name_key: nameKey, // Rules verify this matches my session
          author_team: roster.team, // Rules verify
          author_role: roster.role, // Rules verify
          display_name: roster.display_name,
          created_at: firebase.firestore.FieldValue.serverTimestamp(),
        });
      }
      chatInput.value = "";
    } catch (e) {
      alert("Send failed: " + e.message);
    }
  };

  // Send on Enter in chat
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      if (!chatSend.disabled) chatSend.click();
    }
  });

  /* ===================== 13) Boot guard ===================== */
  (function () {
    if (!resolvedGameId) setPill("stGame", "err", "No GAME_ID");
  })();
</script>
